<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile</title>
    <link rel="stylesheet" href="profile.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
</head>

<body>
    <nav>
        <span id="open-close"><i class='bx bx-menu' style="font-size: 150%; font-family: sans-serif;"></i></span>
        <img src="animal.png" alt="">
    </nav>
    <aside id="aside">
        <div class="container-svg" id="home">
            <div>
                <svg viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" fill="#909090" focusable="false" class="style-scope yt-icon" style="pointer-events: none; display: block; width: 25px; height: 25px;">
                    <g class="style-scope yt-icon">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8" class="style-scope yt-icon"></path>
                    </g>
                </svg>
                <span style="font-size: 94%; font-family: sans-serif;">Home</span>
            </div>
        </div>

        <div class="container-svg" id="profile">
            <div>
                <svg viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" focusable="false" fill="#909090" class="style-scope yt-icon" style="pointer-events: none; display: block; width:25px; height:25px;"><g class="style-scope yt-icon">
                    <path d="m12 3.06 7 3.21v4.84c0 1.3-.25 2.6-.75 3.86-.15.37-.33.76-.55 1.17-.15.27-.31.54-.48.81-1.32 2.01-3.17 3.42-5.23 3.98-2.06-.56-3.91-1.97-5.23-3.98-.17-.27-.33-.54-.48-.81-.22-.41-.4-.79-.55-1.17-.48-1.26-.73-2.56-.73-3.86V6.27l7-3.21m0-1.1L4 5.63v5.49c0 1.47.3 2.9.81 4.22.17.44.37.86.6 1.28.16.3.34.6.52.88 1.42 2.17 3.52 3.82 5.95 4.44l.12.02.12-.03c2.43-.61 4.53-2.26 5.95-4.43.19-.29.36-.58.52-.88.22-.41.43-.84.6-1.28.51-1.33.81-2.76.81-4.23V5.63l-8-3.67zm1.08 10.15c-.32-.06-.64-.11-.96-.12A2.997 2.997 0 0012 6a2.996 2.996 0 00-.12 5.99c-.32.01-.64.06-.96.12C8.64 12.58 7 14.62 7 17h10c0-2.38-1.64-4.42-3.92-4.89zM10 9c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm1.12 4.09c.37-.08.64-.11.88-.11s.51.03.88.11c1.48.3 2.63 1.46 3 2.91H8.12c.37-1.45 1.52-2.61 3-2.91z"></path>
                </svg>
                <span style="font-size: 94%; font-family: sans-serif;">Profile</span>
            </div>
        </div>

        <div class="container-svg" id="logout">
            <div>       
                <svg viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" focusable="false" fill="#909090" class="style-scope yt-icon" style="pointer-events: none; display: block; width:25px; height:25px;">
                    <g class="style-scope yt-icon">
                        <path d="M20 3v18H8v-1h11V4H8V3h12zm-8.9 12.1.7.7 4.4-4.4L11.8 7l-.7.7 3.1 3.1H3v1h11.3l-3.2 3.3z"></path>
                    </g>
                </svg>         
                <span style="font-size: 94%; font-family: sans-serif;">Logout</span>
            </div>
        </div>

        <div class="container-svg">
            <h2 style="font-size: 94%; font-family: sans-serif;">Configuration</h2>
            <div>
                <span style="font-size: 94%; font-family: sans-serif;">Change Password</span>
            </div>
        </div>
        
    </aside>
        <div class="container light-style flex-grow-8 container-p-y"    >
            <h4 class="font-weight-bold py-8 mb-4" style="color: rgb(255, 255, 255);">
                Profile
            </h4>
            <div class="card overflow-hidden">
                <div class="row no-gutters row-bordered row-border-light">
                    <div class="col-md-3 pt-0">
                        <div class="list-group list-group-flush account-settings-links">
                            <a class="list-group-item list-group-item-action active" data-toggle="list"
                                href="#account-general">General</a>
                            <a class="list-group-item list-group-item-action" data-toggle="list"
                                href="#account-info">Info</a>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="tab-content">
                            <div class="tab-pane fade active show" id="account-general">
                                <div class="card-body media align-items-center">
                                    <img src="https://bootdey.com/img/Content/avatar/avatar1.png" alt
                                        class="d-block ui-w-80">
                                    <div class="media-body ml-4">
                                        <label class="btn btn-outline-primary">
                                            Upload new photo
                                            <input type="file" class="account-settings-fileinput">
                                        </label> &nbsp;
                                        <button type="button" class="btn btn-outline-primary md-btn-flat">Reset</button>
                                        <div class="text-light small mt-1">Allowed JPG, GIF or PNG. Max size of 800K</div>
                                    </div>
                                </div>
                                <hr class="border-light m-0">
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Username</label>
                                        <input type="text" name="username" id="username" class="form-control mb-1">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Name</label>
                                        <input type="text" name="nombre" id="nombre" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Last Name</label>
                                        <input type="text" name="apellido" id="apellido" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">E-mail</label>
                                        <input type="text" name="correo" id="correo" class="form-control mb-1">
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="account-info">
                                <div class="card-body pb-2">
                                    <div class="form-group">
                                        <label class="form-label">Bio</label>
                                        <textarea class="form-control" name="bio" id="bio"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Birthday</label>
                                        <input type="date" name="fecha_nacimiento" id="fecha_nacimiento"class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Country</label>
                                        <select class="custom-select" id="country-select">
                                            <option selected disabled>Select a country</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-right mt-3">
                    <button type="button" class="btn btn-outline-primary" onclick="saveChanges()">Save changes</button>&nbsp;
                    <button type="button" class="btn btn-outline-primary" onclick="window.location.href='home.html';">Cancel</button>
                </div>
            </div>
        </div>
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript">
        
    </script>
    <script>
        // Función para cargar los países
        async function loadCountries() {
            const response = await fetch('https://restcountries.com/v3.1/all'); // API para obtener todos los países
            const countries = await response.json();

            const select = document.getElementById('country-select');

            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.cca2; // Valor del país (código de dos letras)
                option.textContent = country.name.common; // Nombre común del país
                select.appendChild(option); // Agrega la opción al select
            });

            return countries; // Retorna la lista de países
        }

        // Cargar los países al cargar la página
        window.onload = async () => {
            const countries = await loadCountries(); // Espera a que se carguen los países

            // Carga los datos del usuario
            try {
                const response = await fetch('/api/user');
                if (!response.ok) throw new Error('Error al cargar los datos del usuario');

                const userData = await response.json();

                // Mostrar los datos en los campos del formulario
                document.getElementById('username').value = userData.username;
                document.getElementById('nombre').value = userData.nombre;
                document.getElementById('correo').value = userData.correo; // Asegúrate de tener un campo para esto
                document.getElementById('bio').value = userData.bio;
                document.getElementById('apellido').value = userData.apellido;
                // Formatear la fecha de nacimiento
                if (userData.fecha_nacimiento) {
                    const fechaFormateada = new Date(userData.fecha_nacimiento).toISOString().split('T')[0];
                    document.getElementById('fecha_nacimiento').value = fechaFormateada;
                }

                // Seleccionar el país en el select
                if (userData.pais) {
                    const select = document.getElementById('country-select');
                    select.value = userData.pais; // Selecciona el valor del país
                    
                }

            } catch (error) {
                console.error('Error al obtener datos del usuario:', error);
            }
        };

        //Actualizacion de datos
        async function saveChanges() {
            // Obtener los valores de los campos del formulario
            const username = document.getElementById('username').value;
            const nombre = document.getElementById('nombre').value;
            const apellido = document.getElementById('apellido').value;
            const correo = document.getElementById('correo').value;
            const bio = document.getElementById('bio').value;
            const fecha_nacimiento = document.getElementById('fecha_nacimiento').value;
            const pais = document.getElementById('country-select').value;

            // Crear un objeto con los datos
            const userData = {
                username,
                nombre,
                apellido,
                correo,
                bio,
                fecha_nacimiento,
                pais,
            };

            try {
                const response = await fetch('/api/updateUser', { // Cambia la URL según tu API
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData) // Convertir los datos a JSON
                });

                if (!response.ok) {
                    throw new Error('Error al guardar los cambios');
                }

                const result = await response.json(); // Obtener la respuesta del servidor

                // Puedes mostrar un mensaje de éxito aquí

            } catch (error) {
                console.error('Error al guardar los cambios:', error);
                alert('Failed to save changes. Please try again.');
            }
        }

        // Obtener elementos del DOM
        const $logout = document.getElementById('logout');
        const $profile = document.getElementById('profile');
        const $openClose = document.getElementById("open-close");
        const $aside = document.getElementById("aside");
        const $home = document.getElementById("home"); 

        // Evento para el menú desplegable
        $openClose.addEventListener("click", () => {
            $aside.classList.toggle("desplegar");
        });

         // Evento para el botón de home
        $home.addEventListener('click', function () {
            window.location.href = '/home.html'; // Redirigir a la página de inicio
        });

        // Evento para el botón de profile
        $profile.addEventListener('click', function () {
            window.location.href = '/profile.html'; // Redirigir al perfil de edición
        });        

        // Evento para el botón de logout
        $logout.addEventListener('click', function () {
            fetch('/logout', {
                method: 'POST', // Cambia a 'GET' si tu backend lo requiere
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                if (response.redirected) {
                    window.location.href = response.url; // Redirigir al usuario después de cerrar sesión
                }
            }).catch(error => {
                console.error('Error al cerrar sesión:', error);
            });
        });        

    </script>
  
</body>

</html>